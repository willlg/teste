<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>BRProject - Controle de Tarefas</title>
  <link rel="stylesheet" href="https://brproject.vercel.app/css/brproject.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 8px;
      background-color: transparent;
      color: #333;
      font-size: 12px;
    }
    
    .brproject-container {
      max-width: 100%;
      background: white;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .brproject-content {
      padding: 12px;
    }
    
    .brproject-status-running {
      background: #e8f5e9;
      border: 1px solid #4caf50;
      border-radius: 6px;
      padding: 10px;
      color: #2e7d32;
      margin-bottom: 12px;
    }
    
    .brproject-status-running .status-icon {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #4caf50;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .brproject-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s ease;
      min-height: 16px;
    }
    
    .brproject-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .brproject-button-primary {
      background: #0079bf;
      color: white;
    }
    
    .brproject-button-primary:hover:not(:disabled) {
      background: #005a8b;
    }
    
    .brproject-button-success {
      background: #4caf50;
      color: white;
    }
    
    .brproject-button-success:hover:not(:disabled) {
      background: #388e3c;
    }
    
    .brproject-button-danger {
      background: #f44336;
      color: white;
    }
    
    .brproject-button-danger:hover:not(:disabled) {
      background: #d32f2f;
    }
    
    .brproject-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .brproject-form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .brproject-form-group label {
      font-weight: 500;
      color: #333;
      font-size: 11px;
    }
    
    .brproject-form-group input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .brproject-form-group input:focus {
      outline: none;
      border-color: #0079bf;
      box-shadow: 0 0 0 2px rgba(0, 121, 191, 0.1);
    }
    
    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding: 6px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 11px;
    }
    
    .logout-button {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 10px;
      text-decoration: underline;
    }
    
    .logout-button:hover {
      color: #333;
    }
    
    .feedback {
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 8px;
      font-size: 11px;
    }
    
    .feedback-success {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #4caf50;
    }
    
    .feedback-error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #f44336;
    }
  </style>
</head>
<body>
  <div class="brproject-container">
    <div class="brproject-content">
      <div id="brproject-root">
        <div style="text-align: center; color: #666;">Carregando...</div>
      </div>
    </div>
  </div>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script src="config.js"></script>
  <script src="vendor/jquery.min.js"></script>
  <script src="vendor/md5.js"></script>
  <script src="brproject.js"></script>
  <script>
    console.log('[DEBUG] card-control.html carregado');
    
    let t;
    let cardId = null;
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[DEBUG] DOM Ready no card-control');
      initializePowerUp();
    });

    function initializePowerUp() {
      try {
        console.log('[DEBUG] Inicializando card-control');
        t = window.TrelloPowerUp.iframe();
        console.log('[DEBUG] TrelloPowerUp.iframe criado');
        
        t.render(function() {
          console.log('[DEBUG] Trello render callback executado no card-control');
          return initializeApp();
        });
        
      } catch (e) {
        console.log('[DEBUG] Erro ao chamar TrelloPowerUp.iframe no card-control:', e);
        setTimeout(initializeApp, 1000);
      }
    }

    async function getUserData() {
      try {
        if (!t) {
          console.log('[DEBUG] t não disponível em getUserData');
          return { token: null, url: null, usuario: null };
        }
        
        const token = await t.get('member', 'private', 'brproject-token');
        const url = await t.get('member', 'private', 'brproject-url');
        const usuario = await t.get('member', 'private', 'brproject-usuario');
        
        return { token, url, usuario };
      } catch (e) {
        console.log('[DEBUG] Erro em getUserData:', e);
        return { token: null, url: null, usuario: null };
      }
    }

    async function setUserData(token, url, usuario) {
      try {
        if (!t) {
          console.log('[DEBUG] t não disponível em setUserData');
          return;
        }
        
        await t.set('member', 'private', 'brproject-token', token);
        await t.set('member', 'private', 'brproject-url', url);
        await t.set('member', 'private', 'brproject-usuario', usuario);
        
        // Atualizar badge do usuário no card
        await t.set('member', 'private', 'brproject-usuario', usuario);
      } catch (e) {
        console.log('[DEBUG] Erro em setUserData:', e);
      }
    }

    async function clearUserData() {
      try {
        if (!t) {
          console.log('[DEBUG] t não disponível em clearUserData');
          return;
        }
        
        await t.remove('member', 'private', 'brproject-token');
        await t.remove('member', 'private', 'brproject-url');
        await t.remove('member', 'private', 'brproject-usuario');
        await t.remove('card', 'shared', 'brproject-status');
      } catch (e) {
        console.log('[DEBUG] Erro em clearUserData:', e);
      }
    }

    async function getCardId() {
      try {
        if (!t) {
          console.log('[DEBUG] t não disponível em getCardId');
          return null;
        }
        
        const context = await t.getContext();
        console.log('[DEBUG] Context:', context);
        
        if (context && context.card) {
          console.log('[DEBUG] Card ID do context:', context.card);
          return context.card;
        }
        
        return null;
        
      } catch (e) {
        console.log('[DEBUG] Erro em getCardId:', e);
        return null;
      }
    }

    async function getCardData() {
      try {
        if (!t || !cardId) {
          console.log('[DEBUG] t ou cardId não disponível em getCardData');
          return null;
        }
        
        const card = await t.card('id', 'name', 'desc', 'url');
        console.log('[DEBUG] Dados do card:', card);
        return card;
        
      } catch (e) {
        console.log('[DEBUG] Erro em getCardData:', e);
        return null;
      }
    }

    function renderUI({ logado, tarefaEmAndamento, usuario, tarefaDetalhe, feedback, cardData }) {
      console.log('[DEBUG] renderUI chamado no card-control:', { logado, tarefaEmAndamento, usuario, tarefaDetalhe, feedback, cardData });
      
      let html = '';
      
      if (feedback) {
        html += `<div class="feedback feedback-${feedback.type}">${feedback.msg}</div>`;
      }
      
      if (!logado) {
        html += `<button id="btn-login" class="brproject-button brproject-button-primary">Login no BRProject</button>`;
      } else if (!tarefaEmAndamento) {
        html += `
          <div class="user-info">
            <span>Olá, ${usuario && usuario.email ? usuario.email : ''}</span>
            <button id="btn-logout" class="logout-button">Sair</button>
          </div>
          <button id="btn-iniciar" class="brproject-button brproject-button-success" ${!cardId ? 'disabled' : ''}>
            ${!cardId ? 'Card não identificado' : 'Iniciar Tarefa'}
          </button>
        `;
      } else {
        html += `
          <div class="user-info">
            <span>Olá, ${usuario && usuario.email ? usuario.email : ''}</span>
            <button id="btn-logout" class="logout-button">Sair</button>
          </div>
          <div class="brproject-status-running">
            <div class="status-icon"></div>
            <strong>Em execução:</strong><br>
            <strong>Tarefa:</strong> ${tarefaDetalhe.nome || ''}<br>
            <strong>Descrição:</strong> ${tarefaDetalhe.descricao || ''}<br>
            <strong>Início:</strong> ${tarefaDetalhe.data_inicio || ''}<br>
          </div>
          <button id="btn-parar" class="brproject-button brproject-button-danger">Parar Tarefa</button>
        `;
      }
      
      const root = document.getElementById('brproject-root');
      if (root) {
        root.innerHTML = html;
        // Atualizar altura do iframe
        if (t) {
          t.sizeTo('#brproject-root');
        }
      } else {
        console.log('[DEBUG] Elemento brproject-root não encontrado');
      }
    }

    function renderLogoutConfirm(usuario) {
      const root = document.getElementById('brproject-root');
      if (root) {
        root.innerHTML = `
          <div class="user-info">
            <span>Olá, ${usuario && usuario.email ? usuario.email : ''}</span>
          </div>
          <div style="margin-bottom:10px;">Tem certeza que deseja sair do BRProject?</div>
          <button id="btn-logout-sim" class="brproject-button brproject-button-danger" style="margin-right:8px;">Sim</button>
          <button id="btn-logout-nao" class="brproject-button brproject-button-primary">Não</button>
        `;
        if (t) {
          t.sizeTo('#brproject-root');
        }
      }
    }

    async function initializeApp() {
      console.log('[DEBUG] initializeApp iniciado no card-control');
      
      try {
        if (typeof Brproject === 'undefined') {
          console.log('[DEBUG] Brproject não definido, tentando novamente em 500ms');
          setTimeout(initializeApp, 500);
          return;
        }

        console.log('[DEBUG] Antes do new Brproject');
        var brproject = new Brproject();
        console.log('[DEBUG] Depois do new Brproject');
        
        cardId = await getCardId();
        console.log('[DEBUG] Card ID obtido:', cardId);
        
        const cardData = await getCardData();
        console.log('[DEBUG] Dados do card obtidos:', cardData);

        let { token, url, usuario } = await getUserData();
        console.log('[DEBUG] Dados do usuário:', { token: !!token, url: !!url, usuario });
        
        brproject.token = token;
        brproject.url = url;

        let logado = !!token && !!url;
        let tarefaEmAndamento = false;
        let tarefaDetalhe = {};
        let feedback = null;

        console.log('[DEBUG] Estado inicial:', { logado, cardId });

        if (logado && cardId) {
          console.log('[DEBUG] Verificando última tarefa...');
          await brproject.getUltimaTarefa({
            success: function(data) {
              console.log('[DEBUG] getUltimaTarefa sucesso:', data);
              if (data.success && data.data.atividade.finalizada != 1 && data.data.atividade.tarefa.referencia_id == cardId) {
                tarefaEmAndamento = true;
                tarefaDetalhe = {
                  nome: data.data.atividade.tarefa.nome,
                  descricao: data.data.atividade.tarefa.descricao,
                  data_inicio: data.data.atividade.data_inicio
                };
                // Atualizar status do card
                t.set('card', 'shared', 'brproject-status', 'running');
              }
              console.log('[DEBUG] Renderizando UI após getUltimaTarefa');
              renderUI({ logado, tarefaEmAndamento, usuario, tarefaDetalhe, cardData });
            },
            error: function(error) {
              console.log('[DEBUG] getUltimaTarefa erro:', error);
              renderUI({ logado, tarefaEmAndamento, usuario, tarefaDetalhe, cardData });
            }
          });
        } else {
          console.log('[DEBUG] Renderizando UI inicial');
          renderUI({ logado, tarefaEmAndamento, usuario, tarefaDetalhe, cardData });
        }

        setupEventListeners(brproject, cardId, cardData);
        
      } catch (e) {
        console.log('[DEBUG] Erro no initializeApp:', e);
        renderUI({ 
          logado: false, 
          tarefaEmAndamento: false, 
          usuario: null, 
          tarefaDetalhe: {}, 
          feedback: {type:'error', msg:'Erro ao inicializar aplicação'},
          cardData: null
        });
      }
    }

    function setupEventListeners(brproject, cardId, cardData) {
      console.log('[DEBUG] Configurando event listeners no card-control');
      
      const root = document.getElementById('brproject-root');
      if (!root) {
        console.log('[DEBUG] Root não encontrado para event listeners');
        return;
      }

      root.addEventListener('click', async function(e) {
        const target = e.target;
        console.log('[DEBUG] Click detectado em:', target.id);

        if (target.id === 'btn-login') {
          console.log('[DEBUG] Botão login clicado');
          root.innerHTML = `
            <form id="brproject-form-login" class="brproject-form">
              <div class="brproject-form-group">
                <label>URL</label>
                <input id="brproject-url" name="url" value="https://www2.projetos.brsis.com.br/brproject" type="text" autocomplete="off" />
              </div>
              <div class="brproject-form-group">
                <label>E-mail</label>
                <input id="brproject-email" name="email" type="email" autocomplete="off" />
              </div>
              <div class="brproject-form-group">
                <label>Senha</label>
                <input id="brproject-senha" name="senha" type="password" autocomplete="off" />
              </div>
              <button class="brproject-button brproject-button-primary" type="submit">Entrar</button>
              <p class="error" style="color:red;"></p>
            </form>
          `;
          if (t) {
            t.sizeTo('#brproject-root');
          }
        }

        if (target.id === 'btn-logout') {
          console.log('[DEBUG] Botão logout clicado');
          const { token, url, usuario } = await getUserData();
          renderLogoutConfirm(usuario);
        }

        if (target.id === 'btn-logout-nao') {
          console.log('[DEBUG] Logout cancelado');
          location.reload(); 
        }

        if (target.id === 'btn-logout-sim') {
          console.log('[DEBUG] Logout confirmado');
          await clearUserData();
          brproject.token = null;
          brproject.url = null;
          renderUI({ 
            logado: false, 
            tarefaEmAndamento: false, 
            usuario: null, 
            tarefaDetalhe: {}, 
            feedback: {type:'success',msg:'Logout realizado com sucesso!'},
            cardData: null
          });
        }

        if (target.id === 'btn-iniciar') {
          console.log('[DEBUG] Botão iniciar clicado');
          if (!cardId) {
            renderUI({ 
              logado: true, 
              tarefaEmAndamento: false, 
              usuario: null, 
              tarefaDetalhe: {}, 
              feedback: {type:'error',msg:'Card não identificado.'},
              cardData: cardData
            });
            return;
          }
          
          let tarefaNome = cardData && cardData.name ? cardData.name : 'Tarefa sem nome';
          let tarefaDescricao = cardData && cardData.desc ? cardData.desc : '';
          
          var tarefa = { 
            nome: tarefaNome,
            descricao: tarefaDescricao,
            referencia_id: cardId 
          };
          
          brproject.iniciarTarefa(tarefa, {
            success: function(data) {
              console.log('[DEBUG] Tarefa iniciada com sucesso:', data);
              if (data.success) {
                const tarefaDetalhe = {
                  nome: data.data.atividade.tarefa.nome,
                  descricao: data.data.atividade.tarefa.descricao,
                  data_inicio: data.data.atividade.data_inicio
                };
                t.set('card', 'shared', 'brproject-status', 'running');
                renderUI({ 
                  logado: true, 
                  tarefaEmAndamento: true, 
                  usuario: null, 
                  tarefaDetalhe, 
                  feedback: {type:'success',msg:'Tarefa iniciada!'},
                  cardData: cardData
                });
              } else {
                renderUI({ 
                  logado: true, 
                  tarefaEmAndamento: false, 
                  usuario: null, 
                  tarefaDetalhe: {}, 
                  feedback: {type:'error',msg: data.message || 'Erro ao iniciar tarefa'},
                  cardData: cardData
                });
              }
            },
            error: function(error) {
              console.log('[DEBUG] Erro ao iniciar tarefa:', error);
              renderUI({ 
                logado: true, 
                tarefaEmAndamento: false, 
                usuario: null, 
                tarefaDetalhe: {}, 
                feedback: {type:'error',msg: 'Erro ao iniciar tarefa'},
                cardData: cardData
              });
            }
          });
        }

        if (target.id === 'btn-parar') {
          console.log('[DEBUG] Botão parar clicado');
          brproject.pararTarefa({
            success: function(data) {
              console.log('[DEBUG] Tarefa parada com sucesso:', data);
              // Atualizar status do card
              t.set('card', 'shared', 'brproject-status', 'stopped');
              renderUI({ 
                logado: true, 
                tarefaEmAndamento: false, 
                usuario: null, 
                tarefaDetalhe: {}, 
                feedback: {type:'success',msg:'Tarefa parada!'},
                cardData: cardData
              });
            },
            error: function(error) {
              console.log('[DEBUG] Erro ao parar tarefa:', error);
              renderUI({ 
                logado: true, 
                tarefaEmAndamento: false, 
                usuario: null, 
                tarefaDetalhe: {}, 
                feedback: {type:'error',msg: 'Erro ao parar tarefa'},
                cardData: cardData
              });
            }
          });
        }
      });

      root.addEventListener('submit', async function(e) {
        if (e.target.id === 'brproject-form-login') {
          e.preventDefault();
          console.log('[DEBUG] Form login submetido');
          
          const url = document.getElementById('brproject-url').value;
          const email = document.getElementById('brproject-email').value;
          const senha = document.getElementById('brproject-senha').value;
          const data_form = { url, email, senha };

          const submitBtn = document.querySelector('#brproject-form-login button[type="submit"]');
          const errorEl = document.querySelector('#brproject-form-login .error');
          
          submitBtn.disabled = true;
          submitBtn.textContent = 'Entrando...';
          errorEl.textContent = '';

          brproject.gerarToken(data_form, {
            success: async function(data) {
              console.log('[DEBUG] Token gerado com sucesso:', data);
              if (data.success) {
                await setUserData(data.data.token, url, data.data.usuario);
                brproject.token = data.data.token;
                brproject.url = url;
                renderUI({ 
                  logado: true, 
                  tarefaEmAndamento: false, 
                  usuario: data.data.usuario, 
                  tarefaDetalhe: {}, 
                  feedback: {type:'success',msg:'Login realizado com sucesso!'},
                  cardData: cardData
                });
              } else {
                errorEl.textContent = data.message || 'Erro ao autenticar';
              }
            },
            error: function(error) {
              console.log('[DEBUG] Erro ao gerar token:', error);
              errorEl.textContent = 'Erro ao autenticar';
            },
            complete: function() {
              submitBtn.disabled = false;
              submitBtn.textContent = 'Entrar';
            }
          });
        }
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializePowerUp);
    } else {
      initializePowerUp();
    }
  </script>
</body>
</html>