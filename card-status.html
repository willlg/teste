<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>BRProject - Status do Card</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 12px;
      background: transparent;
      color: #333;
      font-size: 14px;
    }
    
    .brproject-card-status {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .brproject-status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }
    
    .status-icon {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #4caf50;
      animation: pulse 1.5s infinite;
    }
    
    .status-icon.stopped {
      background: #ccc;
      animation: none;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .status-text {
      font-size: 13px;
      color: #666;
    }
    
    .status-text.running {
      color: #2e7d32;
      font-weight: 500;
    }
    
    .brproject-action-button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 60px;
      text-align: center;
    }
    
    .brproject-action-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .brproject-action-button.start {
      background: #0079bf;
      color: white;
    }
    
    .brproject-action-button.start:hover:not(:disabled) {
      background: #005a8b;
    }
    
    .brproject-action-button.stop {
      background: #f44336;
      color: white;
    }
    
    .brproject-action-button.stop:hover:not(:disabled) {
      background: #d32f2f;
    }
    
    .brproject-loading {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #0079bf;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 6px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .task-info {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
      line-height: 1.3;
    }
    
    .error-message {
      color: #c62828;
      font-size: 11px;
      margin-top: 4px;
    }
    
    .success-message {
      color: #2e7d32;
      font-size: 11px;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div id="brproject-card-status">
    <div class="brproject-loading" style="margin: 20px auto; display: block;"></div>
  </div>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script src="config.js"></script>
  <script src="vendor/jquery.min.js"></script>
  <script src="vendor/md5.js"></script>
  <script src="brproject.js"></script>
  <script>
    console.log('[DEBUG] Card Status carregado');
    
    let t;
    let cardId = null;
    let brproject = null;
    let isLoading = false;
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[DEBUG] Card Status DOM Ready');
      initializeCardStatus();
    });

    function initializeCardStatus() {
      try {
        console.log('[DEBUG] Inicializando Card Status');
        t = window.TrelloPowerUp.iframe();
        
        t.render(function() {
          console.log('[DEBUG] Card Status render callback');
          return initializeApp();
        });
        
      } catch (e) {
        console.log('[DEBUG] Erro ao inicializar Card Status:', e);
        setTimeout(initializeApp, 1000);
      }
    }

    async function getUserData() {
      try {
        if (!t) return { token: null, url: null, usuario: null };
        
        const token = await t.get('member', 'private', 'brproject-token');
        const url = await t.get('member', 'private', 'brproject-url');
        const usuario = await t.get('member', 'private', 'brproject-usuario');
        
        return { token, url, usuario };
      } catch (e) {
        console.log('[DEBUG] Erro em getUserData:', e);
        return { token: null, url: null, usuario: null };
      }
    }

    async function getCardId() {
      try {
        if (!t) return null;
        
        const context = await t.getContext();
        if (context && context.card) {
          return context.card;
        }
        
        return null;
      } catch (e) {
        console.log('[DEBUG] Erro em getCardId:', e);
        return null;
      }
    }

    async function getCardData() {
      try {
        if (!t || !cardId) return null;
        
        const card = await t.card('id', 'name', 'desc');
        return card;
      } catch (e) {
        console.log('[DEBUG] Erro em getCardData:', e);
        return null;
      }
    }

    function renderStatus({ isRunning, taskDetail, isLoggedIn, message, messageType }) {
      const container = document.getElementById('brproject-card-status');
      
      if (!isLoggedIn) {
        container.innerHTML = `
          <div class="brproject-card-status">
            <div class="brproject-status-indicator">
              <div class="status-icon stopped"></div>
              <div class="status-text">Não conectado</div>
            </div>
          </div>
        `;
        return;
      }
      
      let html = `<div class="brproject-card-status">`;
      
      if (isRunning && taskDetail) {
        html += `
          <div class="brproject-status-indicator">
            <div class="status-icon"></div>
            <div class="status-text running">Em execução</div>
          </div>
          <button id="btn-stop" class="brproject-action-button stop" ${isLoading ? 'disabled' : ''}>
            ${isLoading ? '<span class="brproject-loading"></span>' : ''}Parar
          </button>
        `;
        
        if (taskDetail.nome) {
          html += `<div class="task-info">Tarefa: ${taskDetail.nome}</div>`;
        }
        if (taskDetail.data_inicio) {
          html += `<div class="task-info">Início: ${taskDetail.data_inicio}</div>`;
        }
      } else {
        html += `
          <div class="brproject-status-indicator">
            <div class="status-icon stopped"></div>
            <div class="status-text">Parado</div>
          </div>
          <button id="btn-start" class="brproject-action-button start" ${isLoading ? 'disabled' : ''}>
            ${isLoading ? '<span class="brproject-loading"></span>' : ''}Iniciar
          </button>
        `;
      }
      
      html += `</div>`;
      
      if (message) {
        html += `<div class="${messageType === 'error' ? 'error-message' : 'success-message'}">${message}</div>`;
      }
      
      container.innerHTML = html;
    }

    async function checkTaskStatus() {
      if (!brproject || !cardId) return false;
      
      return new Promise((resolve) => {
        brproject.getUltimaTarefa({
          success: function(data) {
            console.log('[DEBUG] getUltimaTarefa sucesso:', data);
            if (data.success && 
                data.data.atividade.finalizada != 1 && 
                data.data.atividade.tarefa.referencia_id == cardId) {
              const taskDetail = {
                nome: data.data.atividade.tarefa.nome,
                descricao: data.data.atividade.tarefa.descricao,
                data_inicio: data.data.atividade.data_inicio
              };
              resolve({ isRunning: true, taskDetail });
            } else {
              resolve({ isRunning: false, taskDetail: null });
            }
          },
          error: function(error) {
            console.log('[DEBUG] getUltimaTarefa erro:', error);
            resolve({ isRunning: false, taskDetail: null });
          }
        });
      });
    }

    async function startTask() {
      if (!brproject || !cardId || isLoading) return;
      
      isLoading = true;
      renderStatus({ isRunning: false, taskDetail: null, isLoggedIn: true });
      
      try {
        const cardData = await getCardData();
        const tarefaNome = cardData && cardData.name ? cardData.name : 'Tarefa sem nome';
        const tarefaDescricao = cardData && cardData.desc ? cardData.desc : '';
        
        const tarefa = { 
          nome: tarefaNome,
          descricao: tarefaDescricao,
          referencia_id: cardId 
        };
        
        brproject.iniciarTarefa(tarefa, {
          success: function(data) {
            console.log('[DEBUG] Tarefa iniciada com sucesso:', data);
            isLoading = false;
            
            if (data.success) {
              const taskDetail = {
                nome: data.data.atividade.tarefa.nome,
                descricao: data.data.atividade.tarefa.descricao,
                data_inicio: data.data.atividade.data_inicio
              };
              
              renderStatus({ 
                isRunning: true, 
                taskDetail, 
                isLoggedIn: true,
                message: 'Tarefa iniciada!',
                messageType: 'success'
              });
              
              setTimeout(() => {
                renderStatus({ isRunning: true, taskDetail, isLoggedIn: true });
              }, 3000);
              
            } else {
              renderStatus({ 
                isRunning: false, 
                taskDetail: null, 
                isLoggedIn: true,
                message: data.message || 'Erro ao iniciar tarefa',
                messageType: 'error'
              });
            }
          },
          error: function(error) {
            console.log('[DEBUG] Erro ao iniciar tarefa:', error);
            isLoading = false;
            renderStatus({ 
              isRunning: false, 
              taskDetail: null, 
              isLoggedIn: true,
              message: 'Erro ao iniciar tarefa',
              messageType: 'error'
            });
          }
        });
      } catch (e) {
        isLoading = false;
        console.log('[DEBUG] Erro no startTask:', e);
        renderStatus({ 
          isRunning: false, 
          taskDetail: null, 
          isLoggedIn: true,
          message: 'Erro ao iniciar tarefa',
          messageType: 'error'
        });
      }
    }

    async function stopTask() {
      if (!brproject || isLoading) return;
      
      isLoading = true;
      renderStatus({ isRunning: true, taskDetail: {}, isLoggedIn: true });
      
      brproject.pararTarefa({
        success: function(data) {
          console.log('[DEBUG] Tarefa parada com sucesso:', data);
          isLoading = false;
          
          renderStatus({ 
            isRunning: false, 
            taskDetail: null, 
            isLoggedIn: true,
            message: 'Tarefa parada!',
            messageType: 'success'
          });
          
          setTimeout(() => {
            renderStatus({ isRunning: false, taskDetail: null, isLoggedIn: true });
          }, 3000);
        },
        error: function(error) {
          console.log('[DEBUG] Erro ao parar tarefa:', error);
          isLoading = false;
          renderStatus({ 
            isRunning: true, 
            taskDetail: {}, 
            isLoggedIn: true,
            message: 'Erro ao parar tarefa',
            messageType: 'error'
          });
        }
      });
    }

    async function initializeApp() {
      console.log('[DEBUG] Card Status initializeApp iniciado');
      
      try {
        if (typeof Brproject === 'undefined') {
          console.log('[DEBUG] Brproject não definido, tentando novamente em 500ms');
          setTimeout(initializeApp, 500);
          return;
        }

        brproject = new Brproject();
        cardId = await getCardId();
        
        console.log('[DEBUG] Card ID obtido:', cardId);
        
        if (!cardId) {
          renderStatus({ 
            isRunning: false, 
            taskDetail: null, 
            isLoggedIn: false,
            message: 'Card não identificado',
            messageType: 'error'
          });
          return;
        }

        const { token, url, usuario } = await getUserData();
        const isLoggedIn = !!token && !!url;
        
        if (!isLoggedIn) {
          renderStatus({ isRunning: false, taskDetail: null, isLoggedIn: false });
          return;
        }
        
        brproject.token = token;
        brproject.url = url;

        const { isRunning, taskDetail } = await checkTaskStatus();
        renderStatus({ isRunning, taskDetail, isLoggedIn: true });

        setupEventListeners();
        
      } catch (e) {
        console.log('[DEBUG] Erro no Card Status initializeApp:', e);
        renderStatus({ 
          isRunning: false, 
          taskDetail: null, 
          isLoggedIn: false,
          message: 'Erro ao carregar',
          messageType: 'error'
        });
      }
    }

    function setupEventListeners() {
      const container = document.getElementById('brproject-card-status');
      
      container.addEventListener('click', async function(e) {
        if (e.target.id === 'btn-start') {
          console.log('[DEBUG] Botão iniciar clicado no card status');
          await startTask();
        }
        
        if (e.target.id === 'btn-stop') {
          console.log('[DEBUG] Botão parar clicado no card status');
          await stopTask();
        }
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeCardStatus);
    } else {
      initializeCardStatus();
    }
  </script>
</body>
</html>