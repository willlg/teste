<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 8px;
      background: transparent;
      font-size: 12px;
    }
    
    .brproject-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 8px;
      border: none;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      min-height: 20px;
      margin-bottom: 2px;
    }
    
    .brproject-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .brproject-button-start {
      background: #0079bf;
      color: white;
    }
    
    .brproject-button-start:hover:not(:disabled) {
      background: #005a8b;
    }
    
    .brproject-button-stop {
      background: #f44336;
      color: white;
    }
    
    .brproject-button-stop:hover:not(:disabled) {
      background: #d32f2f;
    }
    
    .brproject-loading {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 6px;
    }
    
    .brproject-edit-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 8px;
      border: none;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      min-height: 20px;
      margin-bottom: 4px;
      background: #00875a;
      color: white;
      text-decoration: none;
    }
    
    .brproject-edit-button:hover {
      background: #006644;
      text-decoration: none;
      color: white;
    }
    
    .brproject-info {
      margin-top: 8px;
      padding: 6px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 11px;
      line-height: 1.4;
    }
    
    .brproject-info-item {
      margin: 2px 0;
      color: #5e6c84;
    }
    
    .brproject-info-label {
      font-weight: 600;
      color: #42526e;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="brproject-status">
    <button class="brproject-button brproject-button-start" disabled>Carregando...</button>
  </div>
  
  <a id="edit-button" href="#" class="brproject-edit-button" target="_blank" style="display: none;">
    Editar Tarefa
  </a>
  
  <div id="brproject-info" class="brproject-info" style="display: none;">
    <div class="brproject-info-item">
      <span class="brproject-info-label">Cliente:</span> 
      <span id="cliente-nome">-</span>
    </div>
    <div class="brproject-info-item">
      <span class="brproject-info-label">Projeto:</span> 
      <span id="projeto-nome">-</span>
    </div>
  </div>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script src="config.js"></script>
  <script src="vendor/jquery.min.js"></script>
  <script src="vendor/md5.js"></script>
  <script src="brproject.js"></script>
  <script>
    let t;
    let cardId = null;
    let brproject = null;
    let taskData = null;
    
    document.addEventListener('DOMContentLoaded', function() {
      initializeCardStatus();
    });

    function initializeCardStatus() {
      try {
        t = window.TrelloPowerUp.iframe();
        t.render(function() {
          return initializeApp();
        });
      } catch (e) {
        console.log('[DEBUG] Erro ao inicializar:', e);
        setTimeout(initializeApp, 1000);
      }
    }

    async function getUserData() {
      try {
        if (!t) return { token: null, url: null, usuario: null };
        
        const token = await t.get('member', 'private', 'brproject-token');
        const url = await t.get('member', 'private', 'brproject-url');
        const usuario = await t.get('member', 'private', 'brproject-usuario');
        
        return { token, url, usuario };
      } catch (e) {
        return { token: null, url: null, usuario: null };
      }
    }

    async function getCardId() {
      try {
        if (!t) return null;
        
        const context = await t.getContext();
        if (context && context.card) {
          return context.card;
        }
        return null;
      } catch (e) {
        return null;
      }
    }

    async function getCardData() {
      try {
        if (!t || !cardId) return null;
        const card = await t.card('id', 'name', 'desc');
        return card;
      } catch (e) {
        return null;
      }
    }

    function updateTaskInfo() {
      const infoContainer = document.getElementById('brproject-info');
      const editButtonElement = document.getElementById('edit-button');
      
      if (cardId) {
        editButtonElement.href = `https://www2.projetos.brsis.com.br/brproject/tarefa/update/${cardId}`;
        editButtonElement.style.display = 'inline-flex';
        
        fetchTaskInfo(cardId);
      }
      
      infoContainer.style.display = 'block';
    }

    function fetchTaskInfo(taskId) {
      if (!brproject || !brproject.token) {
        console.log('[DEBUG] Token ou brproject não disponível');
        setDefaultValues();
        return;
      }
      
      console.log('[DEBUG] Token:', brproject.token);
      console.log('[DEBUG] URL:', brproject.url);
      
      const url1 = `https://www2.projetos.brsis.com.br/brproject/api/tarefa/referencia/${taskId}?token=${encodeURIComponent(brproject.token)}`;
      const url2 = `${brproject.url}/api/tarefa/referencia/${taskId}?token=${encodeURIComponent(brproject.token)}`;
      
      console.log('[DEBUG] Tentando URL1:', url1);
      
      if (typeof $ === 'undefined') {
        fetch(url1, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${brproject.token}`,
            'X-Auth-Token': brproject.token
          },
          credentials: 'include'
        })
          .then(response => {
            console.log('[DEBUG] Response status:', response.status);
            if (response.status === 302) {
              console.log('[DEBUG] Redirecionamento 302 detectado, tentando URL alternativa');
              return tryAlternativeUrl(taskId);
            }
            return response.json();
          })
          .then(data => {
            if (data) {
              console.log('[DEBUG] Dados da tarefa:', data);
              processTaskData(data);
            }
          })
          .catch(error => {
            console.log('[DEBUG] Erro ao buscar tarefa:', error);
            tryAlternativeUrl(taskId);
          });
      } else {
        $.ajax({
          url: url1,
          method: 'GET',
          dataType: 'json',
          headers: {
            'Authorization': `Bearer ${brproject.token}`,
            'X-Auth-Token': brproject.token
          },
          xhrFields: {
            withCredentials: true
          },
          success: function(data) {
            console.log('[DEBUG] Dados da tarefa:', data);
            processTaskData(data);
          },
          error: function(xhr, status, error) {
            console.log('[DEBUG] Erro ao buscar tarefa:', xhr.status, status, error);
            if (xhr.status === 302) {
              console.log('[DEBUG] Redirecionamento 302 detectado, tentando URL alternativa');
              tryAlternativeUrl(taskId);
            } else {
              setDefaultValues();
            }
          }
        });
      }
    }

    function tryAlternativeUrl(taskId) {
      if (!brproject || !brproject.url || !brproject.token) {
        setDefaultValues();
        return;
      }
      
      const url = `${brproject.url}/api/tarefa/referencia/${taskId}?token=${encodeURIComponent(brproject.token)}`;
      console.log('[DEBUG] Tentando URL alternativa:', url);
      
      if (typeof $ === 'undefined') {
        fetch(url, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${brproject.token}`,
            'X-Auth-Token': brproject.token
          },
          credentials: 'include'
        })
          .then(response => {
            console.log('[DEBUG] Response status URL alternativa:', response.status);
            if (response.status === 302 || response.status === 401) {
              console.log('[DEBUG] Ainda com problemas de autenticação, tentando método POST');
              return tryPostMethod(taskId);
            }
            return response.json();
          })
          .then(data => {
            if (data) {
              console.log('[DEBUG] Dados da tarefa (URL alternativa):', data);
              processTaskData(data);
            }
          })
          .catch(error => {
            console.log('[DEBUG] Erro URL alternativa:', error);
            tryPostMethod(taskId);
          });
      } else {
        $.ajax({
          url: url,
          method: 'GET',
          dataType: 'json',
          headers: {
            'Authorization': `Bearer ${brproject.token}`,
            'X-Auth-Token': brproject.token
          },
          xhrFields: {
            withCredentials: true
          },
          success: function(data) {
            console.log('[DEBUG] Dados da tarefa (URL alternativa):', data);
            processTaskData(data);
          },
          error: function(xhr, status, error) {
            console.log('[DEBUG] Erro URL alternativa:', xhr.status, status, error);
            tryPostMethod(taskId);
          }
        });
      }
    }

    function tryPostMethod(taskId) {
      if (!brproject || !brproject.url || !brproject.token) {
        setDefaultValues();
        return;
      }
      
      const url = `${brproject.url}/api/tarefa/referencia/${taskId}`;
      console.log('[DEBUG] Tentando método POST:', url);
      
      const postData = {
        token: brproject.token
      };
      
      if (typeof $ === 'undefined') {
        fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(postData),
          credentials: 'include'
        })
          .then(response => {
            console.log('[DEBUG] Response status POST:', response.status);
            return response.json();
          })
          .then(data => {
            console.log('[DEBUG] Dados da tarefa (POST):', data);
            processTaskData(data);
          })
          .catch(error => {
            console.log('[DEBUG] Erro método POST:', error);
            setDefaultValues();
          });
      } else {
        $.ajax({
          url: url,
          method: 'POST',
          data: JSON.stringify(postData),
          contentType: 'application/json',
          dataType: 'json',
          success: function(data) {
            console.log('[DEBUG] Dados da tarefa (POST):', data);
            processTaskData(data);
          },
          error: function(xhr, status, error) {
            console.log('[DEBUG] Erro método POST:', xhr.status, status, error);
            setDefaultValues();
          }
        });
      }
    }

    function processTaskData(data) {
      const clienteElement = document.getElementById('cliente-nome');
      const projetoElement = document.getElementById('projeto-nome');
      
      if (data && data.success && data.data && data.data.tarefa) {
        const tarefa = data.data.tarefa;
        
        let clienteNome = 'Não informado';
        if (tarefa.cliente && tarefa.cliente.nome) {
          clienteNome = tarefa.cliente.nome;
        }
        
        let projetoNome = 'Não informado';
        if (tarefa.projeto && tarefa.projeto.nome) {
          projetoNome = tarefa.projeto.nome;
        }
        
        clienteElement.textContent = clienteNome;
        projetoElement.textContent = projetoNome;
        
        console.log('[DEBUG] Cliente:', clienteNome, 'Projeto:', projetoNome);
      } else {
        setDefaultValues();
      }
    }

    function setDefaultValues() {
      document.getElementById('cliente-nome').textContent = 'Não informado';
      document.getElementById('projeto-nome').textContent = 'Não informado';
    }

    function renderButton(isRunning, isLoading = false) {
      const container = document.getElementById('brproject-status');
      
      if (isRunning) {
        container.innerHTML = `
          <button id="btn-stop" class="brproject-button brproject-button-stop" ${isLoading ? 'disabled' : ''}>
            ${isLoading ? '<span class="brproject-loading"></span>' : ''}Parar Tarefa
          </button>
        `;
      } else {
        container.innerHTML = `
          <button id="btn-start" class="brproject-button brproject-button-start" ${isLoading ? 'disabled' : ''}>
            ${isLoading ? '<span class="brproject-loading"></span>' : ''}Iniciar Tarefa
          </button>
        `;
      }
    }

    async function checkTaskStatus() {
      if (!brproject || !cardId) return false;
      
      return new Promise((resolve) => {
        brproject.getUltimaTarefa({
          success: function(data) {
            taskData = data; 
            
            if (data.success && 
                data.data && 
                data.data.atividade &&
                data.data.atividade.finalizada != 1 && 
                data.data.atividade.tarefa &&
                data.data.atividade.tarefa.referencia_id == cardId) {
              resolve(true);
            } else {
              resolve(false);
            }
          },
          error: function(error) {
            console.log('[DEBUG] Erro ao buscar tarefa:', error);
            resolve(false);
          }
        });
      });
    }

    async function loadTaskInfo() {
      if (cardId && brproject) {
        updateTaskInfo(); 
      }
    }

    async function startTask() {
      if (!brproject || !cardId) return;
      
      renderButton(false, true);
      
      try {
        const cardData = await getCardData();
        const tarefaNome = cardData && cardData.name ? cardData.name : 'Tarefa sem nome';
        const tarefaDescricao = cardData && cardData.desc ? cardData.desc : '';
        
        const tarefa = { 
          nome: tarefaNome,
          descricao: tarefaDescricao,
          referencia_id: cardId 
        };
        
        brproject.iniciarTarefa(tarefa, {
          success: function(data) {
            if (data.success) {
              renderButton(true);
              setTimeout(() => {
                checkTaskStatus();
                loadTaskInfo();
              }, 1000);
            } else {
              renderButton(false);
              alert('Erro ao iniciar tarefa: ' + (data.message || ''));
            }
          },
          error: function(error) {
            renderButton(false);
            alert('Erro ao iniciar tarefa');
          }
        });
      } catch (e) {
        renderButton(false);
        alert('Erro ao iniciar tarefa');
      }
    }

    async function stopTask() {
      if (!brproject) return;
      
      renderButton(true, true);
      
      brproject.pararTarefa({
        success: function(data) {
          renderButton(false);
          setTimeout(() => {
            checkTaskStatus();
            loadTaskInfo();
          }, 1000);
        },
        error: function(error) {
          renderButton(true);
          alert('Erro ao parar tarefa');
        }
      });
    }

    async function initializeApp() {
      try {
        if (typeof Brproject === 'undefined') {
          setTimeout(initializeApp, 500);
          return;
        }

        brproject = new Brproject();
        cardId = await getCardId();
        
        if (!cardId) {
          document.getElementById('brproject-status').innerHTML = 
            '<button class="brproject-button brproject-button-start" disabled>Card não identificado</button>';
          return;
        }

        const { token, url } = await getUserData();
        const isLoggedIn = !!token && !!url;
        
        if (!isLoggedIn) {
          document.getElementById('brproject-status').innerHTML = 
            '<button class="brproject-button brproject-button-start" disabled>Não conectado</button>';
          return;
        }
        
        brproject.token = token;
        brproject.url = url;

        const isRunning = await checkTaskStatus();
        renderButton(isRunning);
        
        await loadTaskInfo();

        document.addEventListener('click', function(e) {
          if (e.target.id === 'btn-start') {
            startTask();
          }
          if (e.target.id === 'btn-stop') {
            stopTask();
          }
        });
        
      } catch (e) {
        document.getElementById('brproject-status').innerHTML = 
          '<button class="brproject-button brproject-button-start" disabled>Erro ao carregar</button>';
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeCardStatus);
    } else {
      initializeCardStatus();
    }
  </script>
</body>
</html>