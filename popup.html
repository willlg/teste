<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>BRProject - Card</title>
  <link rel="stylesheet" href="https://brproject.vercel.app/css/brproject.css">
</head>
<body>
  <div id="brproject-root"></div>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script src="config.js"></script>
  <script src="vendor/jquery.min.js"></script>
<script src="vendor/md5.js"></script>
<script src="brproject.js"></script>
<script>
  console.log('[DEBUG] jQuery:', typeof $);
  console.log('[DEBUG] Brproject:', typeof Brproject);
  window.onerror = function(msg, url, line, col, error) {
    console.log('[DEBUG] window.onerror:', msg, url, line, col, error);
  };

  var t = window.TrelloPowerUp.iframe();

  async function getUserData() {
    return {
      token: await t.get('member', 'private', 'brproject-token'),
      url: await t.get('member', 'private', 'brproject-url'),
      usuario: await t.get('member', 'private', 'brproject-usuario')
    };
  }
  async function setUserData(token, url, usuario) {
    await t.set('member', 'private', 'brproject-token', token);
    await t.set('member', 'private', 'brproject-url', url);
    await t.set('member', 'private', 'brproject-usuario', usuario);
  }
  async function clearUserData() {
    await t.remove('member', 'private', 'brproject-token');
    await t.remove('member', 'private', 'brproject-url');
    await t.remove('member', 'private', 'brproject-usuario');
  }

  function getCardId() {
    return t.arg('card') && t.arg('card').id;
  }

  // Renderização dinâmica da interface
  function renderUI({ logado, tarefaEmAndamento, usuario, tarefaDetalhe, feedback }) {
    let html = '';
    if (feedback) {
      html += `<div style="color:${feedback.type === 'error' ? 'red' : 'green'};margin-bottom:8px;">${feedback.msg}</div>`;
    }
    if (!logado) {
      html += `<button id="btn-login" class="brproject-login-button">Login no BRProject</button>`;
    } else if (!tarefaEmAndamento) {
      html += `
        <div style="margin-bottom:10px;">Olá, ${usuario && usuario.email ? usuario.email : ''} <button id="btn-logout" class="brproject-logout-button" style="float:right;">Sair</button></div>
        <button id="btn-iniciar" class="brproject-player-iniciar">Iniciar</button>
      `;
    } else {
      html += `
        <div style="margin-bottom:10px;">Olá, ${usuario && usuario.email ? usuario.email : ''} <button id="btn-logout" class="brproject-logout-button" style="float:right;">Sair</button></div>
        <div style="background:#e8f5e9;padding:10px;border-radius:5px;margin-bottom:10px;">
          <b>Em execução:</b><br>
          <b>Tarefa:</b> ${tarefaDetalhe.nome || ''}<br>
          <b>Descrição:</b> ${tarefaDetalhe.descricao || ''}<br>
          <b>Início:</b> ${tarefaDetalhe.data_inicio || ''}<br>
        </div>
        <button id="btn-parar" class="brproject-player-pausar">Parar</button>
      `;
    }
    $('#brproject-root').html(html);
  }

  // Modal de confirmação de logout inline
  function renderLogoutConfirm(usuario) {
    $('#brproject-root').html(`
      <div style="margin-bottom:10px;">Olá, ${usuario && usuario.email ? usuario.email : ''}</div>
      <div style="margin-bottom:10px;">Tem certeza que deseja sair do BRProject?</div>
      <button id="btn-logout-sim" style="background:#d32f2f;color:#fff;margin-right:10px;">Sim</button>
      <button id="btn-logout-nao">Não</button>
    `);
  }

  (async function() {
    console.log('[DEBUG] Antes do new Brproject');
    try {
      var brproject = new Brproject();
      console.log('[DEBUG] Depois do new Brproject');
      var cardId = getCardId();

      let { token, url, usuario } = await getUserData();
      brproject.token = token;
      brproject.url = url;

      let logado = !!token && !!url;
      let tarefaEmAndamento = false;
      let tarefaDetalhe = {};
      let feedback = null;

      console.log('[DEBUG] Estado inicial:', { token, url, usuario, logado, cardId });

      if (logado && cardId) {
        await brproject.getUltimaTarefa({
          success: function(data) {
            console.log('[DEBUG] getUltimaTarefa:', data);
            if (data.success && data.data.atividade.finalizada != 1 && data.data.atividade.tarefa.referencia_id == cardId) {
              tarefaEmAndamento = true;
              tarefaDetalhe = {
                nome: data.data.atividade.tarefa.nome,
                descricao: data.data.atividade.tarefa.descricao,
                data_inicio: data.data.atividade.data_inicio
              };
            }
          }
        });
      }

      console.log('[DEBUG] Antes do renderUI:', { logado, tarefaEmAndamento, usuario, tarefaDetalhe });
      renderUI({ logado, tarefaEmAndamento, usuario, tarefaDetalhe });
    } catch (e) {
      console.log('[DEBUG] Erro no bloco principal:', e);
    }

    // Login
    $('#brproject-root').on('click', '#btn-login', function() {
      $('#brproject-root').html(`
        <form id="brproject-form-login">
          <label>URL</label>
          <input id="brproject-url" class="url" name="url" value="https://www2.projetos.brsis.com.br/brproject" type="text" autocomplete="off" style="padding:10px; border:1px solid #ccc; border-radius:4px; width:100%;" />
          <label>E-mail</label>
          <input id="brproject-email" class="email" name="email" type="email" autocomplete="off" style="padding:10px; border:1px solid #ccc; border-radius:4px; width:100%;" />
          <label>Senha</label>
          <input id="brproject-senha" class="senha" name="senha" type="password" autocomplete="off" style="padding:10px; border:1px solid #ccc; border-radius:4px; width:100%;" />
          <button class="primary js-save-changes" type="submit" style="padding:12px; background-color:#0079bf; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer; width:100%; margin-top:10px;">Entrar</button>
          <p class="error" style="color:red;"></p>
        </form>
      `);
    });

    $('#brproject-root').on('submit', '#brproject-form-login', function(e) {
      e.preventDefault();
      var url = $('#brproject-url').val();
      var email = $('#brproject-email').val();
      var senha = $('#brproject-senha').val();
      var data_form = { url, email, senha };

      brproject.gerarToken(data_form, {
        beforeSend: function() {
          $('#brproject-form-login .js-save-changes').prop('disabled', true).text('Entrando...');
          $('#brproject-form-login .error').text('');
        },
        success: async function(data) {
          if (data.success) {
            await setUserData(data.data.token, url, data.data.usuario);
            brproject.token = data.data.token;
            brproject.url = url;
            usuario = data.data.usuario;
            renderUI({ logado: true, tarefaEmAndamento: false, usuario, tarefaDetalhe: {} , feedback: {type:'success',msg:'Login realizado com sucesso!'} });
          } else {
            $('#brproject-form-login .error').text(data.message || 'Erro ao autenticar');
          }
        },
        error: function() {
          $('#brproject-form-login .error').text('Erro ao autenticar');
        },
        complete: function() {
          $('#brproject-form-login .js-save-changes').prop('disabled', false).text('Entrar');
        }
      });
    });

    $('#brproject-root').on('click', '#btn-logout', function() {
      renderLogoutConfirm(usuario);
    });
    $('#brproject-root').on('click', '#btn-logout-nao', function() {
      renderUI({ logado: true, tarefaEmAndamento, usuario, tarefaDetalhe });
    });
    $('#brproject-root').on('click', '#btn-logout-sim', async function() {
      await clearUserData();
      brproject.token = null;
      brproject.url = null;
      renderUI({ logado: false, tarefaEmAndamento: false, usuario: null, tarefaDetalhe: {}, feedback: {type:'success',msg:'Logout realizado com sucesso!'} });
    });

    $('#brproject-root').on('click', '#btn-iniciar', function() {
      if (!cardId) {
        renderUI({ logado, tarefaEmAndamento, usuario, tarefaDetalhe, feedback: {type:'error',msg:'Card não identificado.'} });
        return;
      }
      var tarefa = { referencia_id: cardId };
      brproject.iniciarTarefa(tarefa, {
        success: function(data) {
          if (data.success) {
            tarefaDetalhe = {
              nome: data.data.atividade.tarefa.nome,
              descricao: data.data.atividade.tarefa.descricao,
              data_inicio: data.data.atividade.data_inicio
            };
            renderUI({ logado: true, tarefaEmAndamento: true, usuario, tarefaDetalhe, feedback: {type:'success',msg:'Tarefa iniciada!'} });
          } else {
            renderUI({ logado, tarefaEmAndamento, usuario, tarefaDetalhe, feedback: {type:'error',msg: data.message || 'Erro ao iniciar tarefa'} });
          }
        }
      });
    });

    $('#brproject-root').on('click', '#btn-parar', function() {
      brproject.pararTarefa({
        success: function(data) {
          renderUI({ logado: true, tarefaEmAndamento: false, usuario, tarefaDetalhe: {}, feedback: {type:'success',msg:'Tarefa parada!'} });
        }
      });
    });
  });
</script>
</body>
</html>